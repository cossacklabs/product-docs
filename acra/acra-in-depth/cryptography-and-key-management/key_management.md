---
title: Key management
bookCollapseSection: true
---

## Key management

There are several types of keys (symmetric, asymmetric) used in Acra for different purposes:

* Transport encryption. Acra uses either [Themis Secure Session]({{< ref "themis/crypto-theory/cryptosystems/secure-session.md" >}}) or TLS as transport protection between AcraServer and AcraConnector, or AcraTranslator and AcraConnector. In Themis Secure Session mode, Acra uses transport keypairs: the two parties should exchange public keys, keeping the private keys to themselves. In TLS mode, Acra uses TLS certificates instead of transport keypairs.
* Storage keys. AcraWriter uses the public key for data encryption, AcraServer/AcraTranslator use private asymmetric keys for AcraStruct decryption and symmetric keys for AcraBlock encryption/decryption.
* Searchable encryption. AcraServer and AcraTranslator use these keys to calculate HMAC for blind indexes.
* Zone keys. Asymmetric public keys used by AcraWriter for encryption only. Both symmetric and asymmetric public + private keys used by AcraServer in [multiple Zone mode]({{< ref "/acra/acra-in-depth/cryptography-and-key-management/#zones-INVALID" >}}) or by AcraTranslator for encryption and decryption. 
* Keys for poison records. Used to generate [poison records]({{< ref "/acra/security-controls/intrusion-detection/#poison-records-INVALID" >}}). Both of key types are private and accessible only by AcraServer/AcraTranslator or [acra-poisonrecordmaker]({{< ref "/acra/configuring-maintaining/general-configuration/acra_poisonrecordmaker.md#-INVALID" >}}) utility.
* Keys for secure logging. Used for [audit log]({{< ref "/acra/security-controls/security-logging-and-events/#-INVALID" >}}) and HMAC calculations.
* Authentication storage key for encryption/decryption credentials of AcraWebConfig users.

### Key names and locations

> Note: Read more about handling key names in [Losing your keys]({{< ref "/acra/acra-in-depth/cryptography-and-key-management/key_management.md#losing-your-keys" >}}) and [Renaming your keys]({{< ref "/acra/acra-in-depth/cryptography-and-key-management/key_management.md#renaming-your-keys" >}}).

Each Acra component has to have its own key storage (by default it is key folder `.acrakeys`) that contains a set of keys necessary for the correct functioning of the components:

- AcraConnector needs to have its own transport private key and other party transport public key to establish a [Secure Session connection]({{< ref "themis/crypto-theory/cryptosystems/secure-session.md" >}}). You should put transport public key of AcraServer or AcraTranslator into AcraConnector's key storage, depending on the connection type.

- AcraServer should have:
    - AcraConnector's transport public key and AcraServer's own transport private key. This is necessary for accepting connections from clients via Secure Session
    - Storage and zone asymmetric private key(s) for decrypting AcraStructs generated by AcraWriter.
    - If AcraServer is running in [Transparent proxy mode]({{< ref "/acra/configuring-maintaining/general-configuration/acra_server.md#transparent-proxy-mode-INVALID" >}}), it should possess the zone and storage public key(s) for encrypting the values from SQL queries to AcraStructs and symmetric data encryption keys for AcraBlocks.
    - Poison record keys to be able to detect poison records in database responses.
    - Keys for secure logging that prevents tampering messages, removing, adding or changing the order of log entries
    - Authentication storage key to access AcraWebConfig's credentials and allow update AcraServer's configuration from WebUI.

- AcraTranslator needs to have same keys as AcraServer except authentication storage key.

- AcraWriter should have the storage public key(s). They are necessary for encrypting data into AcraStructs in such a way that would only be readable for AcraServer/AcraTranslator.

- If you're using AcraWebConfig HTTP server to configure AcraServer remotely, the users' credentials are stored encrypted with authentication storage key and are decrypted on AcraServer upon users' login. AcraServer needs to have an authentication storage key.

#### Keys table

##### Asymmetric keys
| Purpose  | Private key  | Stays on  | Public key | Put to 
| --- | --- | --- | --- | ---
| Transport AcraConnector | clientid | AcraConnector | clientid.pub | AcraServer<br/>AcraTranslator 
| Transport AcraServer | clientid_server| AcraServer | clientid_server.pub | AcraConnector 
| Transport AcraTranslator | clientid_translator| AcraTranslator | clientid_translator.pub | AcraConnector
| AcraStruct encryption |  |  | clientid_storage.pub | AcraWriter<br/>AcraTranslator<br/>AcraServer (Transparent proxy mode)
| AcraStruct decryption | clientid_storage | AcraServer<br/>AcraTranslator |  |  |
| AcraStruct encryption with Zones |  |  | zoneid_zone.pub | AcraWriter<br/>AcraTranslator<br/>AcraServer (Transparent proxy mode)
| AcraStruct decryption with Zones | zoneid_zone | AcraServer<br/>AcraTranslator | |  
| Poison record with AcraStruct | poison_key | AcraServer<br/>AcrTranslator | poison_key.pub | AcraServer<br/>AcrTranslator  

##### Symmetric keys
| Purpose  | Symmetric key  | Stays on
| --- | --- | --- 
| AcraBlock encryption + decryption | clientid_storage_sym | AcraServer<br/>AcraTranslator
| AcraBlock encryption + decryption with Zones |zoneid_zone_sym | AcraServer<br/>AcraTranslator
| Poison record with AcraBlock |  zoneid_zone_sym| AcraServer<br/>AcraTranslator
| Searchable encryption + decryption |  clientid_hmac | AcraServer<br/>AcraTranslator
| Secure logging |  secure_log_key | AcraServer<br/>AcraTranslator<br/>AcraConnector
| Authentication storage key for AcraWebConfig's users | auth_key| AcraServer

### Generating all the Acra keys in one go

We described many keys here and the private keys are those keys that are (obviously) stored in an encrypted form. There's a very special key `ACRA_MASTER_KEY` that is used for decryption of private keys for every Acra service. Look after this key very carefully!

> Note: Due to security reasons, AcraConnector and AcraServer/AcraTranslator need to have different `ACRA_MASTER_KEY`.

#### 1.1 Generating `ACRA_MASTER_KEY` on AcraServer/AcraTranslator

Use `acra-keymaker` (available in [Acra packages]({{< ref "acra/configuring-maintaining/installing/installing-from-repository.md" >}})) to generate master key into `master.key` file and assign it into the environment variable on the corresponding server:

```
acra-keymaker --generate_master_key=master.key
export ACRA_MASTER_KEY=`cat master.key | base64`
```

#### 1.2 Generating transport and encryption keys on AcraServer/AcraTranslator

After this, the master key will be used by `acra-keymaker` for encryption of private keys before those are written to the disk.

Now, let's generate keys for Acra's services:

```
acra-keymaker --client_id=someid \
  --generate_acraserver_keys \
  --generate_acratranslator_keys \
  --generate_acrawriter_keys \
  --generate_acrawebconfig_keys \
  --generate_symmetric_storage_key \
  --generate_hmac_key \
  --generate_log_key
```

{{< hint info >}}
Note: You can skip generation keys with flag `--generate_poisonrecord_keys` for poison records because AcraServer/AcraTranslator will generate them automatically if they are not exists.
{{< /hint >}}

Carry out these operations on the machine running AcraServer/AcraTranslator to make sure that the private keys for Acra never leak outside from the server.

The generator will generate and place 6 keys into the `.acrakeys` directory (you can change this with `--keys_output_dir` argument):
```bash
.acrakeys/.poison_key/poison_key.pub
.acrakeys/.poison_key/poison_key
.acrakeys/.poison_key/poison_key_sym
.acrakeys/someid_storage
.acrakeys/someid_storage.pub
.acrakeys/someid_storage_sym
.acrakeys/someid_translator
.acrakeys/someid_translator.pub
.acrakeys/someid_server
.acrakeys/someid_server.pub
.acrakeys/someid_hmac
.acrakeys/secure_log_key
.acrakeys/auth_key
``` 

> Note: For `acra` to work properly, the key folders have to have proper permissions as set by `acra-keymaker`:

* folder 700.
* private keys 600.

#### 2.1 Generating `ACRA_MASTER_KEY` on AcraConnector

Generate second `ACRA_MASTER_KEY` for AcraConnector in the same way, but on the server that runs AcraConnector:

```
acra-keymaker --generate_master_key=master.key
export ACRA_MASTER_KEY=`cat master.key | base64`
```

#### 2.2 Generating transport keys on AcraConnector

Similarly generate transport key for AcraConnector:

```
acra-keymaker --client_id=someid --generate_acraconnector_keys
```

Carry out these operations on the machine running AcraConnector to make sure that the private keys of AcraConnector never leak outside it.

The generator will generate and place 2 keys into the `.acrakeys` directory (you can change this with `--keys_output_dir` argument):

```bash
.acrakeys/someid
.acrakeys/someid.pub
``` 

{{< hint info >}}
Note: For `acra` to work properly, the key folders have to have proper permissions as set by `acra-keymaker`:
{{< /hint >}}

* folder 700.
* private keys 600.


#### 3. Key exchange

The rule is simple: private keys should stay where they were generated and the public key should be moved to the other server/side.

##### 3.1 Exchange transport keys between AcraConnector and AcraServer

Place public key of AcraServer on AcraConnector and place public key of AcraConnector on AcraServer.

| Component | should contain keys | named like these |
| --- | --- | --- |
| AcraConnector | transport public key of AcraServer<br/>transport private key of AcraConnector | `.acrakeys/someid_server.pub`<br/>`.acrakeys/someid` |
| AcraServer | transport public key of AcraConnector<br/>transport private key of AcraServer | `.acrakeys/someid.pub`<br/>`.acrakeys/someid_server` |

##### 3.2 Exchange transport keys between AcraConnector and AcraTranslator

Place public key of AcraTranslator on AcraConnector and public key of AcraConnector on AcraTranslator.

| Component | should contain keys | named like these |
| --- | --- | --- |
| AcraConnector | transport public key of AcraTranslator<br/>transport private key of AcraConnector | `.acrakeys/someid_translator.pub`<br/>`.acrakeys/someid` |
| AcraTranslator | transport public key of AcraConnector<br/>transport private key of AcraTranslator | `.acrakeys/someid.pub`<br/>`.acrakeys/someid_translator` |

##### 3.3 Exchange AcraStruct encryption/decryption keys between AcraWriter and AcraServer/AcraTranslator

| Component | should contain key | named like this |
| --- | --- | --- |
| AcraWriter | storage public key | `.acrakeys/someid_storage.pub` |
| AcraServer | storage private key | `.acrakeys/someid_storage` |
| AcraTranslator | storage private key | `.acrakeys/someid_storage` |

{{< hint warning >}}
All storage symmetric keys must be accessible only by AcraServer or AcraTranslator
{{< /hint >}}

##### 3.4 Exchange AcraStruct Zone keys between AcraWriter and AcraServer/AcraTranslator

Generating Zone keys is different from generating usual AcraStruct encryption keys. You should run `acra-addzone` (also available in [Acra packages]({{< ref "acra/configuring-maintaining/installing/installing-from-repository.md" >}})) on AcraServer to generate zone:

```
acra-addzone
```

When you run it, you should receive a JSON object that looks something like this:

```
{"id":"DDDDDDDDQHpbUSOgYTzqCktp","public_key":"VUVDMgAAAC3yMBGsAmK/wBXZkL8iBv/C+7hqoQtSZpYoi4fZYMafkJbWe2dL"}
```

By decoding a base64-wrapped public key, you get a binary Zone key which should be provided (placed into) to AcraWriter for generating AcraStructs. Zone keys are placed into the key folder and are named `zoneid_zone` for private key and `zoneid_zone.pub` for public key.

| Component | should contain key | named like this |
| --- | --- | --- |
| AcraWriter | zone public key | `.acrakeys/zoneid_zone.pub` |
| AcraServer | zone private key | `.acrakeys/zoneid_zone` |
| AcraTranslator | zone private key | `.acrakeys/zoneid_zone` |

{{< hint warning >}}
Symmetric zone key must be accessible only by AcraServer or AcraTranslator
{{< /hint >}}

Read more about using Zones in the [AcraWriter guide]({{< ref "/acra/guides/advanced-integrations/client-side-integration-with-acra-connector.md#client-side-with-zones#writing" >}}).

### (Re)Generating only some of the keys

If you want to update or re-generate only some particular keys, it can be easily done via CLI parameters for `acra-keymaker` by specifying appropriate flag for key type. Read more about `acra-keymaker's` [CLI parameters]({{< ref "/acra/configuring-maintaining/general-configuration/acra_keymaker.md#-INVALID" >}}). 

Remember to use separate `ACRA_MASTER_KEY` for AcraConnector and AcraServer/AcraTranslator.

If you suddenly update `ACRA_MASTER_KEY` on AcraServer/AcraTranslator, it won't be able to decrypt old private keys (thus won't be able to decrypt AcraStructs/data at all).

### Renaming your keys

Acra stores private keys in encrypted form. Each key has a special filename associated with its `<client_id>`.

The keys are encrypted using Authenticated Encryption with Associated Data (AEAD), where `<client_id>` acts as associated data for AEAD. This means that if you rename any private key (transport, storage, poison_record key, etc.) in the filesystem and lose the information about its former name, Acra won’t be able to decrypt the key. In this case, it’ll be impossible to decrypt the data and you will lose it (if you have no backup).

Do not rename your key(s). If you did – rename the key(s) back to `<client_id>_<key type>` before attempting to decrypt your data.


### Losing your keys

If you lose the [master key]({{< ref "/acra/acra-in-depth/cryptography-and-key-management/#generating-all-the-acra-keys-in-one-go-INVALID" >}}) that’s used for launching AcraServer, you won’t be able to decrypt the data. Yes, it means that there will be no way to decrypt the data and you’ll lose if forever. Store the master key safely!

If the private keys are lost, there will be no way to decrypt the data either. Store the private keys safely!

We recommend storing private keys and the master key in a reliable place (i.e. KMS, HSM).

[Acra EE users](https://www.cossacklabs.com/acra/#pricing) have a chance to retrieve their public keys if you still have your private keys and master keys. If you’ve encountered such a problem, please [contact us](mailto:dev@cossacklabs.com).

### Key decryption errors

You may encounter the following error messages produced by AcraConnector:

```
time="2019-04-03T11:43:16Z" level=info msg="Connect to AcraServer" client_id=backend_client connection_string="tcp://acraserver-acralivedemo:9393/"
time="2019-04-03T11:43:16Z" level=error msg="Can't wrap connection" client_id=backend_client code=538 error="Failed to unprotect data"
time="2019-04-03T11:43:16Z" level=info msg="Close connection with client" client_id=backend_client
```    

And by AcraServer:

``` 
time="2019-04-03T11:43:57Z" level=info msg="Got new connection to AcraServer: 172.20.0.3:42164" connection_string="tcp://0.0.0.0:9393" from_descriptor=false
time="2019-04-03T11:43:57Z" level=error msg="Can't wrap connection from acra-connector" code=538 error=EOF
```    

As `"Can't wrap connection"` and `"Failed to unprotect data"` error messages suggest, this means that AcraServer or AcraConnector cannot decrypt the private transport key necessary to initialise Secure Session.

Possible reasons why AcraServer or AcraConnector can’t decrypt the private keys:

* keys were renamed
* keys were rewritten with other keys
* keys are associated with another `<client_id>`

Make sure that you haven’t renamed the keys and [rename them back]({{< ref "/acra/acra-in-depth/cryptography-and-key-management/key_management.md#renaming-your-keys" >}}) if possible. 